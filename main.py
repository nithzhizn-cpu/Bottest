# ============================================
#   PSYCHO TEST BOT ‚Äî FULL VERSION (UA/EN)
#   20 tests + partner sync + categories
#   Author: ChatGPT
# ============================================

import logging
import os
import sqlite3
import random
import string
from datetime import datetime

from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

# ----------------------------------------------
#               CONFIG
# ----------------------------------------------

API_TOKEN = os.getenv("BOT_TOKEN", "TEST_TOKEN") 
DEFAULT_LANG = "ua"   # –º–æ–≤–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º

logging.basicConfig(level=logging.INFO)

bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)

DB_PATH = "psychotests.db"

# active_states[user_id] = {
#     "test_id": str,
#     "index": int,
#     "answers": [int],
#     "lang": "ua"/"en",
#     "username": str
# }
active_states = {}

# –ö–æ–¥ –¥–ª—è –ø–∞—Ä–Ω–æ—ó —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ:
# partner_sync[user_id] = {"score": int, "code": "ABC123"}
partner_sync = {}

# ----------------------------------------------
#               LOCALIZATION SYSTEM
# ----------------------------------------------

# –û—Å–Ω–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏, –ø–µ—Ä–µ–∫–ª–∞–¥–µ–Ω—ñ –æ–¥—Ä–∞–∑—É
L = {
    "ua": {
        "start_text": (
            "üëã <b>–í—ñ—Ç–∞—é!</b>\n\n"
            "–¶–µ –±–æ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∏—Ö —Ç–µ—Å—Ç—ñ–≤.\n"
            "–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é –Ω–∏–∂—á–µ üëá"
        ),
        "menu_tests": "üß† –¢–µ—Å—Ç–∏",
        "menu_results": "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏",
        "menu_language": "üåê –ú–æ–≤–∞",
        "menu_sync": "üíû –°—É–º—ñ—Å–Ω—ñ—Å—Ç—å",
        "choose_category": "üìÇ –û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é —Ç–µ—Å—Ç—ñ–≤:",
        "choose_test": "üß™ –û–±–µ—Ä—ñ—Ç—å —Ç–µ—Å—Ç:",
        "language_switched": "üåê –ú–æ–≤—É –∑–º—ñ–Ω–µ–Ω–æ!",
        "results_none": "–£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤.",
        "enter_sync_code": "–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: <code>/sync ABC123</code>)",
        "partner_give_code": "–í–∞—à –∫–æ–¥ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞:",
        "partner_not_found": "‚ùå –ö–æ–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.",
        "sync_success": "üíû <b>–†–µ–∑—É–ª—å—Ç–∞—Ç —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ</b>\n\n",
        "test_completed": "–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ!",
    },
    "en": {
        "start_text": (
            "üëã <b>Hello!</b>\n\n"
            "This is a psychological test bot.\n"
            "Choose an option below üëá"
        ),
        "menu_tests": "üß† Tests",
        "menu_results": "üìä Results",
        "menu_language": "üåê Language",
        "menu_sync": "üíû Compatibility",
        "choose_category": "üìÇ Choose a category:",
        "choose_test": "üß™ Choose a test:",
        "language_switched": "üåê Language changed!",
        "results_none": "You have no saved results.",
        "enter_sync_code": "Enter partner code (example: <code>/sync ABC123</code>)",
        "partner_give_code": "Your partner code:",
        "partner_not_found": "‚ùå Code not found.",
        "sync_success": "üíû <b>Compatibility result</b>\n\n",
        "test_completed": "Test completed!",
    }
}

def t(user_id, key):
    """–ü–µ—Ä–µ–∫–ª–∞–¥–∞—á –∑–∞ user_id"""
    lang = user_language.get(user_id, DEFAULT_LANG)
    return L[lang][key]


# user_language[user_id] = "ua"/"en"
user_language = {}

# ----------------------------------------------
#               INIT DATABASE
# ----------------------------------------------

def init_db():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()

    # —Ç–∞–±–ª–∏—Ü—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
    c.execute("""
        CREATE TABLE IF NOT EXISTS results (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            username TEXT,
            test_id TEXT,
            test_title TEXT,
            score INTEGER,
            summary TEXT,
            created_at TEXT
        )
    """)

    # —Ç–∞–±–ª–∏—Ü—è –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –º–æ–≤
    c.execute("""
        CREATE TABLE IF NOT EXISTS user_lang (
            user_id INTEGER PRIMARY KEY,
            lang TEXT
        )
    """)

    conn.commit()
    conn.close()

init_db()

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —ñ–∑ –ë–î
def load_user_languages():
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    rows = c.execute("SELECT user_id, lang FROM user_lang").fetchall()
    conn.close()
    for uid, lang in rows:
        user_language[uid] = lang

load_user_languages()

def save_user_language(uid, lang):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute(
        "INSERT OR REPLACE INTO user_lang (user_id, lang) VALUES (?, ?)",
        (uid, lang)
    )
    conn.commit()
    conn.close()

# ----------------------------------------------
#               ALL TEST DEFINITIONS
# ----------------------------------------------

TESTS = {

    # 1. –Ü–Ω—Ç—Ä–æ–≤–µ—Ä—Ç / –ï–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç
    "intro_extro": {
        "title": "–Ü–Ω—Ç—Ä–æ–≤–µ—Ä—Ç —á–∏ –ï–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç",
        "description": "–í–∏–∑–Ω–∞—á–∞—î –≤–∞—à —Å—Ç–∏–ª—å –≤–∑–∞—î–º–æ–¥—ñ—ó –∑—ñ —Å–≤—ñ—Ç–æ–º.",
        "questions": [
            {"text": "–ù–∞ –≤–µ—á—ñ—Ä—Ü—ñ –≤–∏‚Ä¶", "options": [
                ("–°–ø—ñ–ª–∫—É—é—Å—å –∑ —É—Å—ñ–º–∞", 2),
                ("–õ–∏—à–µ –∑ –±–ª–∏–∑—å–∫–∏–º–∏", 1),
                ("–í—Ç–æ–º–ª—é—é—Å—å –≤—ñ–¥ –ª—é–¥–µ–π", 0)
            ]},
            {"text": "–©–æ –¥–∞—î –≤–∞–º –µ–Ω–µ—Ä–≥—ñ—é?", "options": [
                ("–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —ñ –ø–æ–¥—ñ—ó", 2),
                ("–ö–æ–º–±—ñ–Ω–∞—Ü—ñ—è", 1),
                ("–¢–∏—à–∞ —ñ —Å–∞–º–æ—Ç–∞", 0)
            ]},
            {"text": "–ù–æ–≤—ñ –∑–Ω–∞–π–æ–º—Å—Ç–≤–∞‚Ä¶", "options": [
                ("–õ–µ–≥–∫–æ", 2), ("–Ü–Ω–æ–¥—ñ", 1), ("–í–∞–∂–∫–æ", 0)
            ]},
            {"text": "–õ—é–±–∏—Ç–µ —É–≤–∞–≥—É?", "options": [
                ("–¢–∞–∫", 2), ("–Ü–Ω–æ–¥—ñ", 1), ("–£–Ω–∏–∫–∞—é", 0)
            ]},
            {"text": "–Ø–∫ –ø—Ä–∞—Ü—é—î—Ç–µ –∫—Ä–∞—â–µ?", "options": [
                ("–£ –∫–æ–º–∞–Ω–¥—ñ", 2), ("–ü–æ-—Ä—ñ–∑–Ω–æ–º—É", 1), ("–ù–∞–æ–¥–∏–Ω—Ü—ñ", 0)
            ]},
        ],
    },

    # 2. –°—Ç—Ä–µ—Å
    "stress_level": {
        "title": "–†—ñ–≤–µ–Ω—å –°—Ç—Ä–µ—Å—É",
        "description": "–û—Ü—ñ–Ω–∫–∞ –µ–º–æ—Ü—ñ–π–Ω–æ—ó –Ω–∞–ø—Ä—É–≥–∏.",
        "questions": [
            {"text": "–ß–∞—Å—Ç–æ –≤—Ç–æ–º–∞ –±–µ–∑ –ø—Ä–∏—á–∏–Ω–∏?", "options": [
                ("–ù—ñ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2), ("–ó–∞–≤–∂–¥–∏", 3)
            ]},
            {"text": "–í–∞—à —Å–æ–Ω:", "options": [
                ("–í –Ω–æ—Ä–º—ñ", 0), ("–ë—É–≤–∞—î –≤–∞–∂–∫–æ", 1), ("–ü–æ–≥–∞–Ω–∏–π", 2), ("–ú–∞–π–∂–µ –Ω–µ —Å–ø–ª—é", 3)
            ]},
            {"text": "–†–µ–∞–∫—Ü—ñ—è –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∏:", "options": [
                ("–°–ø–æ–∫—ñ–π–Ω–æ", 0), ("–î—Ä–∞—Ç—É—é—Å—å", 1), ("–°–∏–ª—å–Ω–æ –Ω–µ—Ä–≤—É—é—Å—å", 2), ("–í–∏–±—É—Ö–∞—é", 3)
            ]},
            {"text": "–§—ñ–∑–∏—á–Ω–∞ –Ω–∞–ø—Ä—É–≥–∞:", "options": [
                ("–ù–µ–º–∞—î", 0), ("–†—ñ–¥–∫–æ", 1), ("–ß–∞—Å—Ç–æ", 2), ("–ü–æ—Å—Ç—ñ–π–Ω–æ", 3)
            ]},
            {"text": "–í–º—ñ–Ω–Ω—è —Ä–æ–∑—Å–ª–∞–±–∏—Ç–∏—Å—å:", "options": [
                ("–õ–µ–≥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–°–∫–ª–∞–¥–Ω–æ", 2), ("–ú–∞–π–∂–µ –Ω–µ–º–æ–∂–ª–∏–≤–æ", 3)
            ]},
        ],
    },

    # 3. –°—É–º—ñ—Å–Ω—ñ—Å—Ç—å (—ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π)
    "compatibility": {
        "title": "–°—É–º—ñ—Å–Ω—ñ—Å—Ç—å —É —Å—Ç–æ—Å—É–Ω–∫–∞—Ö",
        "description": "–û—Ü—ñ–Ω–∫–∞ –≤–∞—à–æ–≥–æ —Å—Ç–∏–ª—é —É —Å—Ç–æ—Å—É–Ω–∫–∞—Ö.",
        "questions": [
            {"text": "–Ø–∫ —Ä–µ–∞–≥—É—î—Ç–µ –Ω–∞ –∑–∞—Ç—Ä–∏–º–∫—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ?", "options": [
                ("–°–ø–æ–∫—ñ–π–Ω–æ", 0), ("–¢—Ä–æ—Ö–∏ —Ö–≤–∏–ª—é—é—Å—å", 1), ("–î—É–∂–µ —Ö–≤–∏–ª—é—é—Å—å", 2), ("–ü–∏—à—É –±–∞–≥–∞—Ç–æ", 3)
            ]},
            {"text": "–ü–æ—Ç—Ä–µ–±–∞ —É —Å–≤–æ–±–æ–¥—ñ:", "options": [
                ("–ù–∏–∑—å–∫–∞", 2), ("–°–µ—Ä–µ–¥–Ω—è", 1), ("–í–∏—Å–æ–∫–∞", 0), ("–£–Ω–∏–∫–∞—é –±–ª–∏–∑—å–∫–æ—Å—Ç—ñ", 3)
            ]},
            {"text": "–ì–æ–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ –ø–æ—á—É—Ç—Ç—è:", "options": [
                ("–õ–µ–≥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–í–∞–∂–∫–æ", 2), ("–£–Ω–∏–∫–∞—é", 3)
            ]},
            {"text": "–†–µ–∞–∫—Ü—ñ—è –Ω–∞ –∫—Ä–∏—Ç–∏–∫—É:", "options": [
                ("–ü—Ä–∏–π–º–∞—é", 0), ("–¢—Ä–æ—Ö–∏ –±–æ–ª—è—á–µ", 1), ("–û–±—Ä–∞–∂–∞—é—Å—å", 2), ("–ê—Ç–∞–∫—É—é", 3)
            ]},
            {"text": "–°–ø—ñ–ª—å–Ω—ñ —Ü—ñ–Ω–Ω–æ—Å—Ç—ñ:", "options": [
                ("–î—É–∂–µ –≤–∞–∂–ª–∏–≤—ñ", 0), ("–ü–æ–º—ñ—Ä–Ω–æ", 1), ("–ù–µ —Å–∏–ª—å–Ω–æ", 2), ("–ú–∞–π–∂–µ –Ω—ñ", 3)
            ]},
        ],
    },

    # 4. –°–∞–º–æ–æ—Ü—ñ–Ω–∫–∞
    "self_esteem": {
        "title": "–°–∞–º–æ–æ—Ü—ñ–Ω–∫–∞",
        "description": "–û—Ü—ñ–Ω–∫–∞ —Ä—ñ–≤–Ω—è —Å–∞–º–æ–ø—Ä–∏–π–Ω—è—Ç—Ç—è.",
        "questions": [
            {"text": "–ß–∏ –ø–æ—Ä—ñ–≤–Ω—é—î—Ç–µ —Å–µ–±–µ –∑ —ñ–Ω—à–∏–º–∏?", "options": [
                ("–ù—ñ–∫–æ–ª–∏", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2)
            ]},
            {"text": "–ó–∞–¥–æ–≤–æ–ª–µ–Ω—ñ —Å–æ–±–æ—é?", "options": [
                ("–¢–∞–∫", 0), ("–ù–µ –∑–∞–≤–∂–¥–∏", 1), ("–†—ñ–¥–∫–æ", 2)
            ]},
            {"text": "–ü—Ä–∏–π–º–∞—î—Ç–µ –ø–æ—Ö–≤–∞–ª—É?", "options": [
                ("–õ–µ–≥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ù–µ –≤—ñ—Ä—é", 2)
            ]},
            {"text": "–ë–æ—î—Ç–µ—Å—å –ø–æ–º–∏–ª–æ–∫?", "options": [
                ("–ù—ñ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–¢–∞–∫", 2)
            ]},
            {"text": "–•–≤–∏–ª—é—î –¥—É–º–∫–∞ —ñ–Ω—à–∏—Ö?", "options": [
                ("–ù—ñ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–¢–∞–∫", 2)
            ]},
        ],
    },

    # 5. –¢–∏–ø –ø—Ä–∏–≤‚Äô—è–∑–∞–Ω–æ—Å—Ç—ñ
    "attachment_style": {
        "title": "–¢–∏–ø –ü—Ä–∏–≤'—è–∑–∞–Ω–æ—Å—Ç—ñ",
        "description": "–í–∞—à —Å—Ç–∏–ª—å —É –±–ª–∏–∑—å–∫–∏—Ö —Å—Ç–æ—Å—É–Ω–∫–∞—Ö.",
        "questions": [
            {"text": "–°—Ç—Ä–∞—Ö –ø–æ–∫–∏–Ω–µ–Ω–Ω—è?", "options": [
                ("–ù—ñ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2), ("–ó–∞–≤–∂–¥–∏", 3)
            ]},
            {"text": "–î–æ–≤—ñ—Ä–∞ –ª—é–¥—è–º:", "options": [
                ("–õ–µ–≥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–í–∞–∂–∫–æ", 2), ("–ú–∞–π–∂–µ –Ω–µ–º–æ–∂–ª–∏–≤–æ", 3)
            ]},
            {"text": "–£–Ω–∏–∫–∞–Ω–Ω—è –±–ª–∏–∑—å–∫–æ—Å—Ç—ñ:", "options": [
                ("–ù—ñ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2), ("–ó–∞–≤–∂–¥–∏", 3)
            ]},
            {"text": "–ü–æ—Ç—Ä–µ–±–∞ –≤ –ø—ñ–¥—Ç—Ä–∏–º—Ü—ñ:", "options": [
                ("–í–∏—Å–æ–∫–∞", 0), ("–°–µ—Ä–µ–¥–Ω—è", 1), ("–ù–∏–∑—å–∫–∞", 2), ("–ú–∞–π–∂–µ –Ω–µ —Ç—Ä–µ–±–∞", 3)
            ]},
            {"text": "–í–∞—à —Å—Ç–∞–Ω —É —Å—Ç–æ—Å—É–Ω–∫–∞—Ö:", "options": [
                ("–°—Ç–∞–±—ñ–ª—å–Ω–∏–π", 0), ("–ö–æ–ª–∏–≤–∞–Ω–Ω—è", 1), ("–î–∏—Å—Ç–∞–Ω—Ü—ñ—è", 2), ("–°—Ç—Ä–∞—Ö/—Ö–∞–æ—Å", 3)
            ]},
        ],
    },

    # 6. EQ
    "eq_test": {
        "title": "–ï–º–æ—Ü—ñ–π–Ω–∏–π –Ü–Ω—Ç–µ–ª–µ–∫—Ç (EQ)",
        "description": "–û—Ü—ñ–Ω–∫–∞ –µ–º–æ—Ü—ñ–π–Ω–æ—ó —á—É—Ç–ª–∏–≤–æ—Å—Ç—ñ.",
        "questions": [
            {"text": "–ß–∏ —Ä–æ–∑—É–º—ñ—î—Ç–µ —Å–≤–æ—ó –µ–º–æ—Ü—ñ—ó?", "options": [
                ("–î–æ–±—Ä–µ", 0), ("–ß–∞—Å—Ç–∫–æ–≤–æ", 1), ("–°–∫–ª–∞–¥–Ω–æ", 2)
            ]},
            {"text": "–†–æ–∑—É–º—ñ–Ω–Ω—è —ñ–Ω—à–∏—Ö:", "options": [
                ("–î–æ–±—Ä–µ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ü–æ–≥–∞–Ω–æ", 2)
            ]},
            {"text": "–ö–æ–Ω—Ç—Ä–æ–ª—å –µ–º–æ—Ü—ñ–π:", "options": [
                ("–í–º—ñ—é", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ù–µ –≤–º—ñ—é", 2)
            ]},
            {"text": "–°–ª–æ–≤–∞ –Ω–∞ –µ–º–æ—Ü—ñ—è—Ö:", "options": [
                ("–†—ñ–¥–∫–æ —à–∫–æ–¥—É—é", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2)
            ]},
            {"text": "–£—Å–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–∏—á–∏–Ω –µ–º–æ—Ü—ñ–π:", "options": [
                ("–¢–∞–∫", 0), ("–ß–∞—Å—Ç–∫–æ–≤–æ", 1), ("–ù—ñ", 2)
            ]},
        ],
    },

    # 7. –¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç
    "temperament": {
        "title": "–¢–∏–ø –¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç—É",
        "description": "–ö–ª–∞—Å–∏—á–Ω—ñ —Ç–∏–ø–∏ —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç—ñ–≤.",
        "questions": [
            {"text": "–®–≤–∏–¥–∫—ñ—Å—Ç—å —Ä–µ–∞–∫—Ü—ñ–π:", "options": [
                ("–í–∏—Å–æ–∫–∞", 2), ("–°–µ—Ä–µ–¥–Ω—è", 1), ("–ù–∏–∑—å–∫–∞", 0)
            ]},
            {"text": "–†–µ–∞–∫—Ü—ñ—è –Ω–∞ —Å—Ç—Ä–µ—Å:", "options": [
                ("–ê–∫—Ç–∏–≤–Ω–æ", 2), ("–°–ø–æ–∫—ñ–π–Ω–æ", 1), ("–ó–∞–≤–º–∏—Ä–∞—é", 0)
            ]},
            {"text": "–ó–º—ñ–Ω–∏ –Ω–∞—Å—Ç—Ä–æ—é:", "options": [
                ("–ß–∞—Å—Ç—ñ", 2), ("–†—ñ–¥–∫—ñ", 1), ("–ú–∞–π–∂–µ –Ω–µ–º–∞", 0)
            ]},
            {"text": "–ü—Ä–∏–π–Ω—è—Ç—Ç—è —Ä—ñ—à–µ–Ω—å:", "options": [
                ("–®–≤–∏–¥–∫–æ", 2), ("–Ü–Ω–æ–¥—ñ", 1), ("–ü–æ–≤—ñ–ª—å–Ω–æ", 0)
            ]},
            {"text": "–£ –∫–æ–ª–µ–∫—Ç–∏–≤—ñ:", "options": [
                ("–õ—ñ–¥–µ—Ä", 2), ("–£—á–∞—Å–Ω–∏–∫", 1), ("–°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á", 0)
            ]},
        ],
    },

    # 8. Big Five
    "big_five": {
        "title": "Big Five ‚Äî 5 —Ñ–∞–∫—Ç–æ—Ä—ñ–≤",
        "description": "–í—ñ–¥–∫—Ä–∏—Ç—ñ—Å—Ç—å ‚Ä¢ –î–æ–±—Ä–æ—Å–æ–≤—ñ—Å–Ω—ñ—Å—Ç—å ‚Ä¢ –ï–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å—ñ—è ‚Ä¢ –î–æ–±—Ä–æ–∑–∏—á–ª–∏–≤—ñ—Å—Ç—å ‚Ä¢ –ù–µ–π—Ä–æ—Ç–∏–∑–º",
        "questions": [
            {"text": "–õ—é–±–æ–≤ –¥–æ –Ω–æ–≤–æ–≥–æ:", "options": [
                ("–í–∏—Å–æ–∫–∞", 2), ("–ü–æ–º—ñ—Ä–Ω–∞", 1), ("–ù–∏–∑—å–∫–∞", 0)
            ]},
            {"text": "–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è:", "options": [
                ("–ó–∞–≤–∂–¥–∏", 2), ("–Ü–Ω–æ–¥—ñ", 1), ("–†—ñ–¥–∫–æ", 0)
            ]},
            {"text": "–°–æ—Ü—ñ–∞–ª—å–Ω—ñ—Å—Ç—å:", "options": [
                ("–í–∏—Å–æ–∫–∞", 2), ("–ö–æ–ª–∏–≤–∞—î—Ç—å—Å—è", 1), ("–ù–∏–∑—å–∫–∞", 0)
            ]},
            {"text": "–î–æ–±—Ä–æ—Ç–∞:", "options": [
                ("–í–∏—Å–æ–∫–∞", 2), ("–°–µ—Ä–µ–¥–Ω—è", 1), ("–ù–∏–∑—å–∫–∞", 0)
            ]},
            {"text": "–•–≤–∏–ª—é–≤–∞–Ω–Ω—è:", "options": [
                ("–í–∏—Å–æ–∫–µ", 2), ("–Ü–Ω–æ–¥—ñ", 1), ("–ù–∏–∑—å–∫–µ", 0)
            ]},
        ],
    },

    # 9. MBTI
    "mbti": {
        "title": "MBTI ‚Äî 4 –¥–∏—Ö–æ—Ç–æ–º—ñ—ó",
        "description": "–°–∫–æ—Ä–æ—á–µ–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∏–ø—É.",
        "questions": [
            {"text": "–î–µ –≤–∏ –∑–∞—Ä—è–¥–∂–∞—î—Ç–µ—Å—å?", "options": [
                ("–õ—é–¥–∏", 2), ("–ù–∞–æ–¥–∏–Ω—Ü—ñ", 0)
            ]},
            {"text": "–©–æ –≤–∞–∂–ª–∏–≤—ñ—à–µ?", "options": [
                ("–§–∞–∫—Ç–∏", 2), ("–Ü–Ω—Ç—É—ó—Ü—ñ—è", 0)
            ]},
            {"text": "–ü—Ä–∏–π–Ω—è—Ç—Ç—è —Ä—ñ—à–µ–Ω—å:", "options": [
                ("–õ–æ–≥—ñ–∫–∞", 2), ("–ï–º–æ—Ü—ñ—ó", 0)
            ]},
            {"text": "–°—Ç–∏–ª—å –∂–∏—Ç—Ç—è:", "options": [
                ("–ü–ª–∞–Ω", 2), ("–°–ø–æ–Ω—Ç–∞–Ω–Ω—ñ—Å—Ç—å", 0)
            ]},
        ],
    },

    # 10. –¢—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å
    "anxiety": {
        "title": "–†—ñ–≤–µ–Ω—å –¢—Ä–∏–≤–æ–∂–Ω–æ—Å—Ç—ñ",
        "description": "–ß–∞—Å—Ç–æ—Ç–∞ —Ö–≤–∏–ª—é–≤–∞–Ω—å.",
        "questions": [
            {"text": "–•–≤–∏–ª—é–≤–∞–Ω–Ω—è –±–µ–∑ –ø—Ä–∏—á–∏–Ω–∏:", "options": [
                ("–†—ñ–¥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2)
            ]},
            {"text": "–¢—ñ–ª–æ –Ω–∞–ø—Ä—É–∂–µ–Ω–µ:", "options": [
                ("–ù—ñ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2)
            ]},
            {"text": "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–æ–≥–∞–Ω–æ–≥–æ:", "options": [
                ("–†—ñ–¥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2)
            ]},
            {"text": "–†–æ–∑—Å–ª–∞–±–ª–µ–Ω–Ω—è:", "options": [
                ("–õ–µ–≥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–°–∫–ª–∞–¥–Ω–æ", 2)
            ]},
        ],
    },

    # 11. –î–µ–ø—Ä–µ—Å–∏–≤–Ω—ñ—Å—Ç—å
    "depression": {
        "title": "–î–µ–ø—Ä–µ—Å–∏–≤–Ω—ñ—Å—Ç—å (–ë–µ–∫ —Å–∫–æ—Ä.)",
        "description": "–û–∑–Ω–∞–∫–∏ –µ–º–æ—Ü—ñ–π–Ω–æ–≥–æ –≤–∏—Å–Ω–∞–∂–µ–Ω–Ω—è.",
        "questions": [
            {"text": "–ù–∞—Å—Ç—Ä—ñ–π:", "options": [
                ("–°—Ç–∞–±—ñ–ª—å–Ω–∏–π", 0), ("–ü–æ–Ω–∏–∂–µ–Ω–∏–π", 1), ("–î—É–∂–µ –Ω–∏–∑—å–∫–∏–π", 2)
            ]},
            {"text": "–†–∞–¥—ñ—Å—Ç—å:", "options": [
                ("–ß–∞—Å—Ç–æ", 0), ("–†—ñ–¥–∫–æ", 1), ("–ú–∞–π–∂–µ –Ω–µ–º–∞—î", 2)
            ]},
            {"text": "–ï–Ω–µ—Ä–≥—ñ—è:", "options": [
                ("–Ñ", 0), ("–ú–∞–ª–æ", 1), ("–ù–µ–º–∞—î", 2)
            ]},
            {"text": "–ú–æ—Ç–∏–≤–∞—Ü—ñ—è:", "options": [
                ("–í –Ω–æ—Ä–º—ñ", 0), ("–°–ª–∞–±–∫–∞", 1), ("–ú–∞–π–∂–µ –Ω–µ–º–∞—î", 2)
            ]},
        ],
    },

    # 12. –†–æ–±–æ—á–∏–π —Å—Ç–∏–ª—å
    "work_style": {
        "title": "–†–æ–±–æ—á–∏–π –°—Ç–∏–ª—å",
        "description": "–¢–∏–ø –ø–æ–≤–µ–¥—ñ–Ω–∫–∏ —É —Ä–æ–±–æ—Ç—ñ.",
        "questions": [
            {"text": "–ü–æ—á–∞—Ç–æ–∫ –∑–∞–¥–∞—á:", "options": [
                ("–û–¥—Ä–∞–∑—É", 2), ("–ü—ñ—Å–ª—è –ø–ª–∞–Ω—É", 1), ("–í –æ—Å—Ç–∞–Ω–Ω—é –º–∏—Ç—å", 0)
            ]},
            {"text": "–£ –∫–æ–º–∞–Ω–¥—ñ:", "options": [
                ("–õ—ñ–¥–µ—Ä", 2), ("–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å", 1), ("–°–∞–º", 0)
            ]},
            {"text": "–í–∞–∂–ª–∏–≤—ñ—à–µ:", "options": [
                ("–ü–æ—Ä—è–¥–æ–∫", 2), ("–ì–Ω—É—á–∫—ñ—Å—Ç—å", 1), ("–ö—Ä–µ–∞—Ç–∏–≤", 0)
            ]},
        ],
    },

    # 13. –õ—ñ–¥–µ—Ä—Å—Ç–≤–æ
    "leadership": {
        "title": "–õ—ñ–¥–µ—Ä—Å—å–∫–∏–π –°—Ç–∏–ª—å",
        "description": "–ê–≤—Ç–æ—Ä–∏—Ç–∞—Ä–Ω–∏–π ‚Ä¢ –î–µ–º–æ–∫—Ä–∞—Ç–∏—á–Ω–∏–π ‚Ä¢ –õ—ñ–±–µ—Ä–∞–ª—å–Ω–∏–π",
        "questions": [
            {"text": "–ü—Ä–∏–π–Ω—è—Ç—Ç—è —Ä—ñ—à–µ–Ω—å:", "options": [
                ("–®–≤–∏–¥–∫–æ —ñ —Å–∞–º", 2), ("–û–±–≥–æ–≤–æ—Ä—é—é", 1), ("–î–∞—é —ñ–Ω—à–∏–º", 0)
            ]},
            {"text": "–ö–æ–Ω—Ç—Ä–æ–ª—å:", "options": [
                ("–ñ–æ—Ä—Å—Ç–∫–∏–π", 2), ("–ü–æ–º—ñ—Ä–Ω–∏–π", 1), ("–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π", 0)
            ]},
            {"text": "–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è:", "options": [
                ("–ù–∞–∫–∞–∑–æ–≤–∞", 2), ("–ü–∞—Ä—Ç–Ω–µ—Ä—Å—å–∫–∞", 1), ("–°–ø–æ–∫—ñ–π–Ω–∞", 0)
            ]},
        ],
    },

    # 14. –ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü—ñ—è
    "procrastination": {
        "title": "–ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü—ñ—è",
        "description": "–°—Ö–∏–ª—å–Ω—ñ—Å—Ç—å –≤—ñ–¥–∫–ª–∞–¥–∞—Ç–∏.",
        "questions": [
            {"text": "–í—ñ–¥–∫–ª–∞–¥–∞—î—Ç–µ —Å–ø—Ä–∞–≤–∏?", "options": [
                ("–†—ñ–¥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2)
            ]},
            {"text": "–ü–æ—á–∞—Ç–æ–∫ –∑–∞–¥–∞—á:", "options": [
                ("–õ–µ–≥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–í–∞–∂–∫–æ", 2)
            ]},
            {"text": "–í—ñ–¥–≤–æ–ª—ñ–∫–∞–Ω–Ω—è:", "options": [
                ("–†—ñ–¥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ü–æ—Å—Ç—ñ–π–Ω–æ", 2)
            ]},
        ],
    },

    # 15. –ê–≥—Ä–µ—Å–∏–≤–Ω—ñ—Å—Ç—å
    "aggression": {
        "title": "–ê–≥—Ä–µ—Å–∏–≤–Ω—ñ—Å—Ç—å",
        "description": "–û—Ü—ñ–Ω–∫–∞ —ñ–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—ñ.",
        "questions": [
            {"text": "–ï–º–æ—Ü—ñ–π–Ω—ñ –≤–∏–±—É—Ö–∏:", "options": [
                ("–†—ñ–¥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2)
            ]},
            {"text": "–î—Ä–∞—Ç—ñ–≤–ª–∏–≤—ñ—Å—Ç—å:", "options": [
                ("–ù—ñ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–¢–∞–∫", 2)
            ]},
            {"text": "–†–µ–∞–∫—Ü—ñ—è –Ω–∞ –Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ñ—Å—Ç—å:", "options": [
                ("–°–ø–æ–∫—ñ–π–Ω–æ", 0), ("–ó –∑–∞—É–≤–∞–∂–µ–Ω–Ω—è–º–∏", 1), ("–†—ñ–∑–∫–æ", 2)
            ]},
        ],
    },

    # 16. –ï–º–ø–∞—Ç—ñ—è
    "empathy": {
        "title": "–ï–º–ø–∞—Ç—ñ—è",
        "description": "–í–º—ñ–Ω–Ω—è –≤—ñ–¥—á—É–≤–∞—Ç–∏ —ñ–Ω—à–∏—Ö.",
        "questions": [
            {"text": "–í—ñ–¥—á—É–≤–∞—î—Ç–µ –Ω–∞—Å—Ç—Ä—ñ–π —ñ–Ω—à–∏—Ö?", "options": [
                ("–¢–∞–∫", 2), ("–Ü–Ω–æ–¥—ñ", 1), ("–ù—ñ", 0)
            ]},
            {"text": "–°–ø—ñ–≤–ø–µ—Ä–µ–∂–∏–≤–∞–Ω–Ω—è:", "options": [
                ("–ß–∞—Å—Ç–æ", 2), ("–Ü–Ω–æ–¥—ñ", 1), ("–†—ñ–¥–∫–æ", 0)
            ]},
            {"text": "–†–µ–∞–∫—Ü—ñ—è –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∏ —ñ–Ω—à–∏—Ö:", "options": [
                ("–î–æ–ø–æ–º–∞–≥–∞—é", 2), ("–°–ª—É—Ö–∞—é", 1), ("–£–Ω–∏–∫–∞—é", 0)
            ]},
        ],
    },

    # 17. –°–æ—Ü—ñ–∞–ª—å–Ω–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å
    "social_adapt": {
        "title": "–°–æ—Ü—ñ–∞–ª—å–Ω–∞ –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å",
        "description": "–í–∞—à–µ –≤–º—ñ–Ω–Ω—è –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏—Å—å.",
        "questions": [
            {"text": "–ù–æ–≤—ñ —Å–∏—Ç—É–∞—Ü—ñ—ó:", "options": [
                ("–¶—ñ–∫–∞–≤—ñ", 2), ("–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ñ", 1), ("–°—Ç—Ä–µ—Å–æ–≤—ñ", 0)
            ]},
            {"text": "–ù–æ–≤–∏–π –∫–æ–ª–µ–∫—Ç–∏–≤:", "options": [
                ("–õ–µ–≥–∫–æ", 2), ("–ü–æ—Å—Ç—É–ø–æ–≤–æ", 1), ("–í–∞–∂–∫–æ", 0)
            ]},
            {"text": "–ù–æ–≤–∏–∑–Ω–∞:", "options": [
                ("–õ—é–±–ª—é", 2), ("–Ü–Ω–æ–¥—ñ", 1), ("–£–Ω–∏–∫–∞—é", 0)
            ]},
        ],
    },

    # 18. –ú–æ—Ç–∏–≤–∞—Ü—ñ—è
    "motivation": {
        "title": "–ú–æ—Ç–∏–≤–∞—Ü—ñ—è",
        "description": "–í–∞—à —Ä—É—à—ñ–π–Ω–∏–π —Ñ–∞–∫—Ç–æ—Ä.",
        "questions": [
            {"text": "–©–æ –≥–æ–ª–æ–≤–Ω–µ?", "options": [
                ("–î–æ—Å—è–≥–Ω–µ–Ω–Ω—è", 2), ("–°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å", 1), ("–°–≤–æ–±–æ–¥–∞", 0)
            ]},
            {"text": "–ë—É—Ç–∏ –∫—Ä–∞—â–∏–º –∑–∞ —ñ–Ω—à–∏—Ö?", "options": [
                ("–¢–∞–∫", 2), ("–Ü–Ω–æ–¥—ñ", 1), ("–ù—ñ", 0)
            ]},
            {"text": "–ú–æ—Ç–∏–≤—É—î:", "options": [
                ("–í–∏–∑–Ω–∞–Ω–Ω—è", 2), ("–°—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å", 1), ("–Ü–Ω—Ç–µ—Ä–µ—Å", 0)
            ]},
        ],
    },

    # 19. –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–Ω—ñ—Å—Ç—å
    "conflict": {
        "title": "–ö–æ–Ω—Ñ–ª—ñ–∫—Ç–Ω—ñ—Å—Ç—å",
        "description": "–í–∞—à —Å—Ç–∏–ª—å —É –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ.",
        "questions": [
            {"text": "–°—É–ø–µ—Ä–µ—á–∫–∏:", "options": [
                ("–†—ñ–¥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2)
            ]},
            {"text": "–í—ñ–¥—Å—Ç–æ—é–≤–∞–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó:", "options": [
                ("–ú–∏—Ä–Ω–æ", 0), ("–ù–∞–ø—Ä—É–∂–µ–Ω–æ", 1), ("–†—ñ–∑–∫–æ", 2)
            ]},
            {"text": "–†–µ–∞–∫—Ü—ñ—è –Ω–∞ –Ω–µ–≤–¥–æ–≤–æ–ª–µ–Ω–Ω—è:", "options": [
                ("–°–ø–æ–∫—ñ–π–Ω–æ", 0), ("–ó –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç–æ–º", 1), ("–ê–≥—Ä–µ—Å–∏–≤–Ω–æ", 2)
            ]},
        ],
    },

    # 20. –¢–æ–∫—Å–∏—á–Ω—ñ—Å—Ç—å
    "toxicity": {
        "title": "–¢–æ–∫—Å–∏—á–Ω—ñ—Å—Ç—å",
        "description": "–ß–∏ —à–∫–æ–¥–∏—Ç–µ –≤–∏ —ñ–Ω—à–∏–º –Ω–µ—Å–≤—ñ–¥–æ–º–æ.",
        "questions": [
            {"text": "–ú–∞–Ω—ñ–ø—É–ª—é—î—Ç–µ?", "options": [
                ("–†—ñ–¥–∫–æ", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–ß–∞—Å—Ç–æ", 2)
            ]},
            {"text": "–í–∏–∑–Ω–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫:", "options": [
                ("–¢–∞–∫", 0), ("–Ü–Ω–æ–¥—ñ", 1), ("–†—ñ–¥–∫–æ", 2)
            ]},
            {"text": "–í –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ:", "options": [
                ("–ö–æ–º–ø—Ä–æ–º—ñ—Å", 0), ("–û–±—Ä–∞–∑–∞", 1), ("–ê—Ç–∞–∫–∞", 2)
            ]},
        ],
    },

    # 21. –ü–∞—Ä–Ω–∏–π —Ç–µ—Å—Ç —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
    "partnersync": {
        "title": "–ü–ê–†–ù–ê –°–£–ú–Ü–°–ù–Ü–°–¢–¨",
        "description": (
            "–ü—ñ—Å–ª—è –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è —Ç–µ—Å—Ç—É –≤–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –∫–æ–¥.\n"
            "–ü–∞—Ä—Ç–Ω–µ—Ä –≤–≤–æ–¥–∏—Ç—å —Ü–µ–π –∫–æ–¥ –∫–æ–º–∞–Ω–¥–æ—é /sync ‚Äî —ñ –±–æ—Ç –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É—î –≤–∞—à—É —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å."
        ),
        "questions": [
            {"text": "–Ø–∫ –ø—Ä–æ—è–≤–ª—è—î—Ç–µ –ø–æ—á—É—Ç—Ç—è?", "options": [
                ("–ê–∫—Ç–∏–≤–Ω–æ", 2), ("–ü–æ–º—ñ—Ä–Ω–æ", 1), ("–¢–∏—Ö–æ", 0)
            ]},
            {"text": "–í–∞—à —Å—Ç–∏–ª—å —É –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ:", "options": [
                ("–û–±–≥–æ–≤–æ—Ä—é—é", 2), ("–ú–æ–≤—á—É", 0), ("–ï–º–æ—Ü—ñ–π–Ω–æ", 3)
            ]},
            {"text": "–†–µ–≤–Ω–æ—â—ñ:", "options": [
                ("–ú—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ", 0), ("–ü–æ–º—ñ—Ä–Ω—ñ", 1), ("–í–∏—Å–æ–∫—ñ", 3)
            ]},
            {"text": "–°–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è:", "options": [
                ("–í—ñ–¥–∫—Ä–∏—Ç–µ", 2), ("–ó–∞–ª–µ–∂–∏—Ç—å", 1), ("–ó–∞–∫—Ä–∏—Ç–µ", 0)
            ]},
            {"text": "–°–≤–æ–±–æ–¥–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞:", "options": [
                ("–î—É–∂–µ –≤–∞–∂–ª–∏–≤–∞", 2), ("–ü–æ–º—ñ—Ä–Ω–∞", 1), ("–ù–µ –≤–∞–∂–ª–∏–≤–∞", 0)
            ]},
        ],
    },

}

# ----------------------------------------------
#           TEST CATEGORIES
# ----------------------------------------------

TEST_CATEGORIES = {
    "personality": {
        "title": "üß¨ –û—Å–æ–±–∏—Å—Ç—ñ—Å—Ç—å",
        "tests": ["intro_extro", "big_five", "mbti", "temperament", "self_esteem"]
    },
    "emotions": {
        "title": "üíõ –ï–º–æ—Ü—ñ—ó —Ç–∞ –ø—Å–∏—Ö—ñ—á–Ω–∏–π —Å—Ç–∞–Ω",
        "tests": ["stress_level", "anxiety", "depression", "eq_test", "toxicity"]
    },
    "relationships": {
        "title": "üíû –°—Ç–æ—Å—É–Ω–∫–∏",
        "tests": ["compatibility", "attachment_style", "empathy", "conflict", "partnersync"]
    },
    "work": {
        "title": "üíº –†–æ–±–æ—Ç–∞ —Ç–∞ —Ä–æ–∑–≤–∏—Ç–æ–∫",
        "tests": ["work_style", "leadership", "motivation", "procrastination", "social_adapt"]
    }
}

# ----------------------------------------------
#          EMOTIONAL TAGS FOR RESULTS
# ----------------------------------------------

def emotional_tag(score):
    """–ü–æ–≤–µ—Ä—Ç–∞—î –µ–º–æ–¥–∑—ñ-–º—ñ—Ç–∫—É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Ä—ñ–≤–Ω—è."""
    if score <= 3:
        return "üíö"
    elif score <= 7:
        return "üíõ"
    elif score <= 12:
        return "üß°"
    else:
        return "‚ù§Ô∏è‚Äçüî•"


# ----------------------------------------------
#               SUMMARY INTERPRETATION
# ----------------------------------------------

def build_summary_for_test(test_id: str, total_score: int) -> str:
    tag = emotional_tag(total_score)

    # 1. –Ü–Ω—Ç—Ä–æ–≤–µ—Ä—Å—ñ—è
    if test_id == "intro_extro":
        if total_score <= 4:
            return f"{tag} –í–∏ —ñ–Ω—Ç—Ä–æ–≤–µ—Ä—Ç. –í–∞–º –≤–∞–∂–ª–∏–≤–∞ —Ç–∏—à–∞, –ø—Ä–∏–≤–∞—Ç–Ω—ñ—Å—Ç—å, —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å."
        elif total_score <= 7:
            return f"{tag} –í–∏ –∞–º–±—ñ–≤–µ—Ä—Ç. –ì–Ω—É—á–∫–æ –∞–¥–∞–ø—Ç—É—î—Ç–µ—Å—å –¥–æ —Å–∏—Ç—É–∞—Ü—ñ–π."
        else:
            return f"{tag} –í–∏ –µ–∫—Å—Ç—Ä–∞–≤–µ—Ä—Ç ‚Äî –µ–Ω–µ—Ä–≥—ñ–π–Ω—ñ, —Å–æ—Ü—ñ–∞–ª—å–Ω—ñ, –≤—ñ–¥–∫—Ä–∏—Ç—ñ."

    # 2. –°—Ç—Ä–µ—Å
    if test_id == "stress_level":
        if total_score <= 4:
            return f"{tag} –ù–∏–∑—å–∫–∏–π —Ä—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É. –í–∏ –¥–æ–±—Ä–µ —Å–ø—Ä–∞–≤–ª—è—î—Ç–µ—Å—å."
        elif total_score <= 9:
            return f"{tag} –ü–æ–º—ñ—Ä–Ω–∏–π —Å—Ç—Ä–µ—Å. –í–∞—Ä—Ç–æ –±—ñ–ª—å—à–µ –≤—ñ–¥–ø–æ—á–∏–≤–∞—Ç–∏."
        else:
            return f"{tag} –í–∏—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å. –ú–æ–∂–ª–∏–≤–µ –ø–µ—Ä–µ–Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è."

    # 3. –°—É–º—ñ—Å–Ω—ñ—Å—Ç—å
    if test_id == "compatibility":
        if total_score <= 4:
            return f"{tag} –í–∏ ‚Äî –∑—Ä—ñ–ª–∏–π –ø–∞—Ä—Ç–Ω–µ—Ä. –ì–∞—Ä–Ω–∞ –µ–º–æ—Ü—ñ–π–Ω–∞ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å."
        elif total_score <= 9:
            return f"{tag} –í–∞—à —Å—Ç–∏–ª—å –≤–∑–∞—î–º–æ–¥—ñ—ó –∑–º—ñ—à–∞–Ω–∏–π, —ñ–Ω–æ–¥—ñ –∫–æ–ª–∏–≤–∞—î—Ç—å—Å—è."
        else:
            return f"{tag} –Ñ –æ–∑–Ω–∞–∫–∏ —Ç—Ä–∏–≤–æ–∂–Ω–æ–≥–æ —á–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—é –ø—Ä–∏–≤'—è–∑–∞–Ω–æ—Å—Ç—ñ."

    # 4. –°–∞–º–æ–æ—Ü—ñ–Ω–∫–∞
    if test_id == "self_esteem":
        if total_score <= 2:
            return f"{tag} –ó–¥–æ—Ä–æ–≤–∞ —Å–∞–º–æ–æ—Ü—ñ–Ω–∫–∞."
        elif total_score <= 5:
            return f"{tag} –ü–æ–º—ñ—Ä–Ω–æ –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–∞ —Å–∞–º–æ–æ—Ü—ñ–Ω–∫–∞."
        else:
            return f"{tag} –ó–∞–Ω–∏–∂–µ–Ω–∞ —Å–∞–º–æ–æ—Ü—ñ–Ω–∫–∞."

    # 5. –ü—Ä–∏–≤'—è–∑–∞–Ω—ñ—Å—Ç—å
    if test_id == "attachment_style":
        if total_score <= 3:
            return f"{tag} –ë–µ–∑–ø–µ—á–Ω–∏–π —Å—Ç–∏–ª—å –ø—Ä–∏–≤‚Äô—è–∑–Ω–æ—Å—Ç—ñ."
        elif total_score <= 7:
            return f"{tag} –¢—Ä–∏–≤–æ–∂–Ω–∏–π –∞–±–æ –∑–º—ñ—à–∞–Ω–∏–π —Å—Ç–∏–ª—å."
        elif total_score <= 11:
            return f"{tag} –£–Ω–∏–∫–∞–ª—å–Ω–∏–π —Å—Ç–∏–ª—å."
        else:
            return f"{tag} –ú–æ–∂–ª–∏–≤–æ –¥–µ–∑–æ—Ä–≥–∞–Ω—ñ–∑–æ–≤–∞–Ω–∏–π —Å—Ç–∏–ª—å."

    # 6. EQ
    if test_id == "eq_test":
        if total_score <= 2:
            return f"{tag} –í–∏—Å–æ–∫–∏–π EQ."
        elif total_score <= 5:
            return f"{tag} –°–µ—Ä–µ–¥–Ω—ñ–π EQ."
        else:
            return f"{tag} –ù–∏–∑—å–∫–∏–π EQ."

    # 7. –¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç
    if test_id == "temperament":
        if total_score <= 3:
            return f"{tag} –§–ª–µ–≥–º–∞—Ç–∏—á–Ω–∏–π/–º–µ–ª–∞–Ω—Ö–æ–ª—ñ—á–Ω–∏–π —Ç–∏–ø."
        elif total_score <= 7:
            return f"{tag} –ó–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–∏–π —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç."
        else:
            return f"{tag} –°–∞–Ω–≥–≤—ñ–Ω—ñ–∫ –∞–±–æ —Ö–æ–ª–µ—Ä–∏–∫."

    # 8. Big Five
    if test_id == "big_five":
        if total_score <= 4:
            return f"{tag} –°–ø–æ–∫—ñ–π–Ω–∏–π, —Ä–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π, —Å—Ç—Ä–∏–º–∞–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å."
        elif total_score <= 7:
            return f"{tag} –ì–∞—Ä–º–æ–Ω—ñ–π–Ω–∏–π —Ç–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω–∏–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä."
        else:
            return f"{tag} –ï–º–æ—Ü—ñ–π–Ω–∏–π, –∞–∫—Ç–∏–≤–Ω–∏–π, —Ç–≤–æ—Ä—á–∏–π —Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç."

    # 9. MBTI
    if test_id == "mbti":
        if total_score <= 2:
            return f"{tag} –°—Ö–æ–∂–µ –Ω–∞ INFP/INFJ ‚Äî —Ç–æ–Ω–∫–∞ —ñ–Ω—Ç—É—ó—Ü—ñ—è –π –µ–º–ø–∞—Ç—ñ—è."
        elif total_score <= 5:
            return f"{tag} –ó–º—ñ—à–∞–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å (ENFJ/ISFJ/ESFJ)."
        else:
            return f"{tag} –ô–º–æ–≤—ñ—Ä–Ω–æ ENTJ/ESTJ/INTJ ‚Äî –ª–æ–≥—ñ–∫–∞ –π —Å—Ç—Ä—É–∫—Ç—É—Ä–∞."

    # 10. –¢—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å
    if test_id == "anxiety":
        if total_score <= 2:
            return f"{tag} –ù–∏–∑—å–∫–∞ —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å."
        elif total_score <= 5:
            return f"{tag} –ü–æ–º—ñ—Ä–Ω–∞ —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å."
        else:
            return f"{tag} –í–∏—Å–æ–∫–∞ —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å."

    # 11. –î–µ–ø—Ä–µ—Å–∏–≤–Ω—ñ—Å—Ç—å
    if test_id == "depression":
        if total_score <= 2:
            return f"{tag} –û–∑–Ω–∞–∫ –¥–µ–ø—Ä–µ—Å–∏–≤–Ω–æ—Å—Ç—ñ –Ω–µ–º–∞—î."
        elif total_score <= 5:
            return f"{tag} –õ–µ–≥–∫—ñ –æ–∑–Ω–∞–∫–∏ –µ–º–æ—Ü—ñ–π–Ω–æ–≥–æ –≤–∏—Å–Ω–∞–∂–µ–Ω–Ω—è."
        else:
            return f"{tag} –ú–æ–∂–ª–∏–≤–∞ –¥–µ–ø—Ä–µ—Å–∏–≤–Ω—ñ—Å—Ç—å."

    # 12. –†–æ–±–æ—á–∏–π —Å—Ç–∏–ª—å
    if test_id == "work_style":
        if total_score <= 2:
            return f"{tag} –¢–≤–æ—Ä—á–∏–π —ñ –≤—ñ–ª—å–Ω–∏–π —Å—Ç–∏–ª—å."
        elif total_score <= 4:
            return f"{tag} –°–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–∏–π —Å—Ç–∏–ª—å."
        else:
            return f"{tag} –°—Ç—Ä—É–∫—Ç—É—Ä–Ω–∏–π, —Å–∏—Å—Ç–µ–º–Ω–∏–π —Ä–æ–±–æ—á–∏–π —Å—Ç–∏–ª—å."

    # 13. –õ—ñ–¥–µ—Ä—Å—Ç–≤–æ
    if test_id == "leadership":
        if total_score <= 2:
            return f"{tag} –õ—ñ–±–µ—Ä–∞–ª—å–Ω–∏–π –ª—ñ–¥–µ—Ä."
        elif total_score <= 4:
            return f"{tag} –î–µ–º–æ–∫—Ä–∞—Ç–∏—á–Ω–∏–π —Å—Ç–∏–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è."
        else:
            return f"{tag} –ê–≤—Ç–æ—Ä–∏—Ç–∞—Ä–Ω–∏–π —Å—Ç–∏–ª—å."

    # 14. –ü—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü—ñ—è
    if test_id == "procrastination":
        if total_score <= 2:
            return f"{tag} –ù–∏–∑—å–∫–∞ –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü—ñ—è."
        elif total_score <= 4:
            return f"{tag} –ü–æ–º—ñ—Ä–Ω–∞ –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü—ñ—è."
        else:
            return f"{tag} –í–∏—Å–æ–∫–∞ –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü—ñ—è."

    # 15. –ê–≥—Ä–µ—Å–∏–≤–Ω—ñ—Å—Ç—å
    if test_id == "aggression":
        if total_score <= 2:
            return f"{tag} –ù–∏–∑—å–∫–∞ –∞–≥—Ä–µ—Å–∏–≤–Ω—ñ—Å—Ç—å."
        elif total_score <= 4:
            return f"{tag} –ü–æ–º—ñ—Ä–Ω–∞ –∞–≥—Ä–µ—Å–∏–≤–Ω—ñ—Å—Ç—å."
        else:
            return f"{tag} –í–∏—Å–æ–∫–∞ –∞–≥—Ä–µ—Å–∏–≤–Ω—ñ—Å—Ç—å."

    # 16. –ï–º–ø–∞—Ç—ñ—è
    if test_id == "empathy":
        if total_score <= 2:
            return f"{tag} –ù–∏–∑—å–∫–∞ –µ–º–ø–∞—Ç—ñ—è."
        elif total_score <= 4:
            return f"{tag} –°–µ—Ä–µ–¥–Ω—è –µ–º–ø–∞—Ç—ñ—è."
        else:
            return f"{tag} –í–∏—Å–æ–∫–∞ –µ–º–ø–∞—Ç—ñ—è."

    # 17. –°–æ—Ü. –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å
    if test_id == "social_adapt":
        if total_score <= 2:
            return f"{tag} –ù–∏–∑—å–∫–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å."
        elif total_score <= 4:
            return f"{tag} –°–µ—Ä–µ–¥–Ω—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å."
        else:
            return f"{tag} –í–∏—Å–æ–∫–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å."

    # 18. –ú–æ—Ç–∏–≤–∞—Ü—ñ—è
    if test_id == "motivation":
        if total_score <= 2:
            return f"{tag} –í–∞—Å –º–æ—Ç–∏–≤—É—î —Å–≤–æ–±–æ–¥–∞."
        elif total_score <= 4:
            return f"{tag} –í–∞—Å –º–æ—Ç–∏–≤—É—î —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å."
        else:
            return f"{tag} –í–∞—Å –º–æ—Ç–∏–≤—É—é—Ç—å –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è."

    # 19. –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–Ω—ñ—Å—Ç—å
    if test_id == "conflict":
        if total_score <= 2:
            return f"{tag} –í–∏ —É–Ω–∏–∫–∞—î—Ç–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤."
        elif total_score <= 4:
            return f"{tag} –í–∏ –ø—Ä–∞–≥–Ω–µ—Ç–µ –∫–æ–º–ø—Ä–æ–º—ñ—Å—É."
        else:
            return f"{tag} –í–∏ –ø—Ä—è–º–æ–ª—ñ–Ω—ñ–π–Ω—ñ —Ç–∞ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–Ω—ñ."

    # 20. –¢–æ–∫—Å–∏—á–Ω—ñ—Å—Ç—å
    if test_id == "toxicity":
        if total_score <= 2:
            return f"{tag} –¢–æ–∫—Å–∏—á–Ω—ñ —Ä–∏—Å–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ."
        elif total_score <= 4:
            return f"{tag} –ü–æ–º—ñ—Ä–Ω—ñ —Ç–æ–∫—Å–∏—á–Ω—ñ –ø–∞—Ç–µ—Ä–Ω–∏."
        else:
            return f"{tag} –í–∏—Å–æ–∫–∞ —Ç–æ–∫—Å–∏—á–Ω—ñ—Å—Ç—å."

    # fallback
    return f"{tag} –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ."


# ----------------------------------------------
#               SEND QUESTION
# ----------------------------------------------

async def send_question(chat_id: int, user_id: int):
    state = active_states.get(user_id)
    if not state:
        return

    test_id = state["test_id"]
    idx = state["index"]
    lang = user_language.get(user_id, DEFAULT_LANG)

    test = TESTS[test_id]
    questions = test["questions"]

    if idx >= len(questions):
        await finish_test(chat_id, user_id)
        return

    q = questions[idx]
    text = f"{t(user_id, 'choose_test')}\n\n<b>{q['text']}</b>"

    kb = InlineKeyboardMarkup(row_width=1)
    for option_text, score in q["options"]:
        kb.add(InlineKeyboardButton(
            text=option_text,
            callback_data=f"ans|{test_id}|{score}"
        ))

    await bot.send_message(chat_id, text, parse_mode="HTML", reply_markup=kb)


# ----------------------------------------------
#              FINISH TEST LOGIC
# ----------------------------------------------

async def finish_test(chat_id: int, user_id: int):
    state = active_states.get(user_id)
    if not state:
        return

    test_id = state["test_id"]
    answers = state["answers"]

    total_score = sum(answers)
    summary = build_summary_for_test(test_id, total_score)
    test = TESTS[test_id]

    # save in DB
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute(
        "INSERT INTO results (user_id, username, test_id, test_title, score, summary, created_at) "
        "VALUES (?, ?, ?, ?, ?, ?, ?)",
        (
            user_id,
            state.get("username"),
            test_id,
            test["title"],
            total_score,
            summary,
            datetime.utcnow().isoformat(),
        ),
    )
    conn.commit()
    conn.close()

    del active_states[user_id]

    # If partner sync test
    if test_id == "partnersync":
        code = ''.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(6))
        partner_sync[user_id] = {"score": total_score, "code": code}

        await bot.send_message(
            chat_id,
            f"üíû –í–∞—à –∫–æ–¥ –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞:\n\n<code>{code}</code>\n\n"
            f"–ü–æ–ø—Ä–æ—Å—ñ—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –Ω–∞–ø–∏—Å–∞—Ç–∏:\n<code>/sync {code}</code>",
            parse_mode="HTML"
        )

        return

    # Normal test
    await bot.send_message(
        chat_id,
        f"‚úÖ <b>{test['title']}</b>\n"
        f"–ë–∞–ª: <b>{total_score}</b>\n\n"
        f"{summary}",
        parse_mode="HTML"
    )


# ----------------------------------------------
#           PARTNER SYNC MATCHING
# ----------------------------------------------

@dp.message_handler(commands=["sync"])
async def sync_handler(message: types.Message):
    parts = message.text.strip().split()

    if len(parts) < 2:
        await message.answer(t(message.from_user.id, "enter_sync_code"), parse_mode="HTML")
        return

    code = parts[1].upper()
    target_user = None
    target_score = None

    # –ø–æ—à—É–∫ –ø–æ –∫–æ–¥—É
    for uid, data in partner_sync.items():
        if data["code"] == code:
            target_user = uid
            target_score = data["score"]
            break

    if target_user is None:
        await message.answer(t(message.from_user.id, "partner_not_found"))
        return

    # –Æ–∑–µ—Ä –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Ç–µ—Å—Ç partnersync
    partner_id = message.from_user.id

    if partner_id not in partner_sync:
        await message.answer("–°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–π–¥—ñ—Ç—å —Ç–µ—Å—Ç ¬´–ü–ê–†–ù–ê –°–£–ú–Ü–°–ù–Ü–°–¢–¨¬ª!")
        return

    user_score = partner_sync[partner_id]["score"]

    difference = abs(target_score - user_score)

    if difference <= 3:
        compatibility = "üíö –Ü–¥–µ–∞–ª—å–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å"
    elif difference <= 7:
        compatibility = "üíõ –ì–∞—Ä–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å"
    elif difference <= 12:
        compatibility = "üß° –ü–æ—Å–µ—Ä–µ–¥–Ω—è, –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Ä–æ–±–æ—Ç–∞ –Ω–∞–¥ —Å–æ–±–æ—é"
    else:
        compatibility = "‚ù§Ô∏è‚Äçüî• –í–∏–±—É—Ö–æ–≤–∞ —Ç–∞ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å"

    await message.answer(
        f"{t(message.from_user.id, 'sync_success')}"
        f"–ü–∞—Ä—Ç–Ω–µ—Ä—Å—å–∫–∏–π –∫–æ–¥: <b>{code}</b>\n\n"
        f"–†—ñ–∑–Ω–∏—Ü—è —É –±–∞–ª–ª–∞—Ö: <b>{difference}</b>\n"
        f"{compatibility}",
        parse_mode="HTML"
    )

# ----------------------------------------------
#               MAIN MENU KEYBOARD
# ----------------------------------------------

def main_menu(user_id):
    lang = user_language.get(user_id, DEFAULT_LANG)

    kb = InlineKeyboardMarkup(row_width=2)
    kb.add(
        InlineKeyboardButton(t(user_id, "menu_tests"), callback_data="menu_tests"),
        InlineKeyboardButton(t(user_id, "menu_results"), callback_data="menu_results"),
    )
    kb.add(
        InlineKeyboardButton(t(user_id, "menu_language"), callback_data="menu_language"),
        InlineKeyboardButton(t(user_id, "menu_sync"), callback_data="menu_sync"),
    )
    return kb


# ----------------------------------------------
#                   START
# ----------------------------------------------

@dp.message_handler(commands=["start"])
async def cmd_start(message: types.Message):
    uid = message.from_user.id

    if uid not in user_language:
        user_language[uid] = DEFAULT_LANG
        save_user_language(uid, DEFAULT_LANG)

    await message.answer(
        t(uid, "start_text"),
        parse_mode="HTML",
        reply_markup=main_menu(uid)
    )


# ----------------------------------------------
#               CALLBACK: MENU
# ----------------------------------------------

@dp.callback_query_handler(lambda c: c.data == "menu_language")
async def cb_language(call: types.CallbackQuery):
    uid = call.from_user.id

    new_lang = "en" if user_language.get(uid, DEFAULT_LANG) == "ua" else "ua"
    user_language[uid] = new_lang
    save_user_language(uid, new_lang)

    await call.message.edit_reply_markup(main_menu(uid))
    await call.answer(t(uid, "language_switched"))


@dp.callback_query_handler(lambda c: c.data == "menu_tests")
async def cb_tests(call: types.CallbackQuery):
    uid = call.from_user.id

    kb = InlineKeyboardMarkup(row_width=1)
    for cat_id, cat_data in TEST_CATEGORIES.items():
        kb.add(InlineKeyboardButton(cat_data["title"], callback_data=f"cat|{cat_id}"))

    await call.message.answer(
        t(uid, "choose_category"),
        reply_markup=kb
    )
    await call.answer()


@dp.callback_query_handler(lambda c: c.data.startswith("cat|"))
async def cb_category(call: types.CallbackQuery):
    uid = call.from_user.id
    _, cat_id = call.data.split("|", 1)

    tests = TEST_CATEGORIES[cat_id]["tests"]
    kb = InlineKeyboardMarkup(row_width=1)

    for test_id in tests:
        kb.add(InlineKeyboardButton(
            TESTS[test_id]["title"],
            callback_data=f"start|{test_id}"
        ))

    await call.message.answer(
        t(uid, "choose_test"),
        reply_markup=kb
    )
    await call.answer()


# ----------------------------------------------
#              SHOW USER RESULTS
# ----------------------------------------------

@dp.callback_query_handler(lambda c: c.data == "menu_results")
async def cb_results(call: types.CallbackQuery):
    uid = call.from_user.id

    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    rows = c.execute(
        "SELECT test_title, score, summary, created_at FROM results WHERE user_id=? ORDER BY id DESC LIMIT 10",
        (uid,)
    ).fetchall()
    conn.close()

    if not rows:
        await call.message.answer(t(uid, "results_none"))
        await call.answer()
        return

    msg = "üìä <b>–í–∞—à—ñ –æ—Å—Ç–∞–Ω–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:</b>\n\n"

    for title, score, summary, created_at in rows:
        date = created_at.split("T")[0]
        msg += f"‚Ä¢ <b>{title}</b> ({date}) ‚Äî –±–∞–ª: {score}\n"
        msg += f"{summary}\n\n"

    await call.message.answer(msg, parse_mode="HTML")
    await call.answer()


# ----------------------------------------------
#              CALLBACK: START TEST
# ----------------------------------------------

@dp.callback_query_handler(lambda c: c.data.startswith("start|"))
async def cb_start_test(call: types.CallbackQuery):
    uid = call.from_user.id
    _, test_id = call.data.split("|", 1)

    active_states[uid] = {
        "test_id": test_id,
        "index": 0,
        "answers": [],
        "lang": user_language.get(uid, DEFAULT_LANG),
        "username": call.from_user.username or call.from_user.full_name
    }

    test = TESTS[test_id]

    await call.message.answer(
        f"üß™ <b>{test['title']}</b>\n\n{test['description']}",
        parse_mode="HTML"
    )

    await send_question(call.message.chat.id, uid)
    await call.answer()


# ----------------------------------------------
#             CALLBACK: ANSWER OPTION
# ----------------------------------------------

@dp.callback_query_handler(lambda c: c.data.startswith("ans|"))
async def cb_answer(call: types.CallbackQuery):
    uid = call.from_user.id
    _, test_id, score = call.data.split("|", 2)
    score = int(score)

    if uid not in active_states:
        await call.answer("–°–µ—Å—ñ—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞.", show_alert=True)
        return

    state = active_states[uid]

    if state["test_id"] != test_id:
        await call.answer("–¶–µ –Ω–µ –≤–∞—à —Ç–µ—Å—Ç.", show_alert=True)
        return

    state["answers"].append(score)
    state["index"] += 1

    await call.answer("–ó–±–µ—Ä–µ–∂–µ–Ω–æ ‚úî")
    await send_question(call.message.chat.id, uid)


# ----------------------------------------------
#                   LAUNCH BOT
# ----------------------------------------------

if __name__ == "__main__":
    if API_TOKEN == "TEST_TOKEN":
        print("‚ö†Ô∏è –£–í–ê–ì–ê: –í–∏ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ BOT_TOKEN —É Railway –ø–µ—Ä–µ–º—ñ–Ω–Ω–∏—Ö.")
    print("üöÄ BOT IS RUNNING...")
    executor.start_polling(dp, skip_updates=True)
